interpreter: bash -c
usage: arenactl
options:
  launchdir:
    # this is a go-tusk quirk
    environment: PWD

  THIS_TUSK:
    default: "tusk -qf tusk-arena.yml"

  diamond-deploy:
    usage: "defaults to npx diamond-deploy to use the version installed for this package development tree"
    default: "npx diamond-deploy"
    environment: "ARENASTATE_DIAMOND_DEPLOY_CMD"

  rpc:
    default: http://localhost:8545
    environment: ARENASTATE_PROVIDER_URL
    short: "u"

  deploy-key:
    default:
      command: cat .local/dev/wallets/wallet-deploy.key
    environment: ARENASTATE_DEPLOY_KEY
    short: "d"

  owner-key:
    default:
      command: cat .local/dev/wallets/arena-owner.key
    environment: ARENASTATE_OWNER_KEY
    short: "k"

  depdir:
    usage: the directory to store deployment json files in
    default: ./.local/dev/deployed

  deploy-new:
    type: bool

  dry-run:
    type: bool

  diamond-address:
  diamond-nonce:

tasks:
  diamond-find:
    options:
      diamond-nonce:
    run:
      - command:
          exec: |
            set -e

            ${diamond-deploy} \
              -u "${rpc}" \
              -d "${deploy-key}" \
              find \
                $([ -n '${diamond-nonce}' ] && echo -n '--diamond-nonce ${diamond-nonce}' )

  deploy-arena:
    options:
      diamond-address:
        environment: ARENASTATE_ARENA
      diamond-nonce:
      dry-run:
        type: bool
      gasprice:
    run:
      - command:
          exec: |
            set -e

            ${diamond-deploy} list \
              -I facet -n Diamond DiamondNew \
              -i node_modules/@polysensus/chaintrap-contracts/abi \
              --format json -x node_modules/@polysensus/chaintrap-contracts/abi/facets-exclude.json \
              > diamond-deploy.json

            ${diamond-deploy} \
              -u "${rpc}" \
              -d "${deploy-key}" \
              diamond-up \
                $(!${dry-run} && echo -n '--commit' ) \
                $([ -n '${diamond-address}' ] && echo -n '--diamond-address ${diamond-address}' ) \
                $([ -n '${diamond-nonce}' ] && echo -n '--diamond-nonce ${diamond-nonce}' ) \
                --replace \
                $([ -n '${gasprice}' ] && echo -n '--gasprice ${gasprice}' ) \
                --legacy \
                --diamond-owner-key ${owner-key} \
                --ignore-names DiamondNew \
                -f diamond-deploy.json

  deploy-arena-new:
    options:
      gasprice:
      dry-run:
        type: bool
    run:
      - command:
          exec: |
            set -e

            ${diamond-deploy} list \
              -I facet -n Diamond DiamondNew \
              -i node_modules/@polysensus/chaintrap-contracts/abi \
              --format json -x node_modules/@polysensus/chaintrap-contracts/abi/facets-exclude.json \
              > diamond-deploy.json

            ${diamond-deploy} \
              -u "${rpc}" \
              -d "${deploy-key}" \
              diamond-new \
                $(!${dry-run} && echo -n '--commit' ) \
                --replace \
                $([ -n '${gasprice}' ] && echo -n '--gasprice ${gasprice}' ) \
                --legacy \
                --diamond-owner-key ${owner-key} \
                --diamond-init-name DiamondNew \
                --diamond-init-args \
                  '[{"typeURIs": ["GAME_TYPE", "TRANSCRIPT_TYPE", "FURNITURE_TYPE"]}]' \
                -f diamond-deploy.json
